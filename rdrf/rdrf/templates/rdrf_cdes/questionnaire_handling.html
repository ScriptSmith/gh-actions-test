{% extends "rdrf_cdes/base.html" %}
{% load static %}

{% block extrahead %}
<script type="text/javascript" src="{% static 'js/lookup.js' %}"></script>
<script type="text/javascript">
  function QuestionnaireHandlerGui(rpc,
  patientInfoPanelId,
  patientInfoResultPanelId, patientDataPanelId, patientDataTableId,questionnaireContainerId,questionnaireDataPanelId) {
  this.rpc = rpc;
  this.patientInfoPanel = $("#" + patientInfoPanelId);
  this.patientInfoResultPanel = $("#" + patientInfoResultPanelId);
  this.patientDataPanel = $("#" + patientDataPanelId);
  this.patientDataTable = $("#" + patientDataTableId);
  this.questionnaieContainer = $("#" + questionnaireContainerId);
  this.questionnaireDataPanel = $("#" + questionnaireDataPanelId);
  this.cdeRowTemplate = _.template("<tr><td><%= name %></td><td><%= value %></td></tr>");
  }
  
  QuestionnaireHandlerGui.prototype.wireUp = function () {
  var self = this;
  this.patientInfoPanel.delegate('input[type=radio]', 'click', function() {
  var action = this.value;
         if(action == "create") {
         self.patientInfoResultPanel.hide();
         self.patientDataPanel.hide();
         self.questionnaireContainer
            .removeClass('col-md-6')
            .addClass('col-md-12');
         self.patientInfoPanel.hide();
     }
  else {
     console.log("to do update"); 
  };});}

  QuestionnaireHandlerGui.prototype.loadPatientData = function (data) {
      var patientName = data.name;
      var patientLink = $('<a>', { href: data.link, text: patientName});
      var self = this;
      this.patientInfoResultPanel.empty();
      this.patientInfoResultPanel.append(patientLink);
      _.each(data.questions, function (question) {
             console.log("add cde " + question.name);
             self.addPatientCde(question);
    });
  }
        
  

  QuestionnaireHandlerGui.prototype.addPatientCde = function (question) {
    var rowHtml = this.cdeRowTemplate({name: question.name, value: question.answer});
    this.patientDataTable.append(rowHtml);
  }

  QuestionnaireHandlerGui.prototype.clearPatientData = function () {
      console.log("clearing table");
  }

  QuestionnaireHandlerGui.prototype.showPatientPanel = function () {
      console.log("shjow panel");
  }

  QuestionnaireHandlerGui.prototype.showError = function (errorMessage) {
  $("#messages").val(errorMessage);
  }
  
  $(document).ready(function() {

      $.ajaxSetup({
          beforeSend: function (xhr) {
              var csrfToken = '{{ csrf_token }}';
              xhr.setRequestHeader('X-CSRFToken', csrfToken);
          }
      });

      var rpc = new RPC.RPC("{% url 'rpc' %}", "{{csrf_token}}");
      


      $("#patient_lookup").keyup(function () {
          lookupPatient($(this), '{{patient_lookup_url}}');
      });

      function lookupPatient(element, source_url) {
          element.autocomplete({
              source: source_url,
              minLength: 1,
              select: function (event, ui) {
                  $(element).data("patient_id", ui.item.pk);
              }
          }).data("ui-autocomplete")._renderItem = function (ul, item) {
              item.pk = item.value;  // so we can load
              item.value = item.label;
              return $("<li>")
                      .append("<a>" + item.label + "</a>")
                      .appendTo(ul);
          };
      }

      var gui = new QuestionnaireHandlerGui(rpc,
                                          "patient-info",
                                          "patient-info-result",
                                          "patient-data",
                                          "patient-table",
                                          "questionnaire-container",
                                          "questionnaire-data");

      gui.wireUp();


      $("#load_patient_button").click(function () {
          var qrModelId = {{qr_model.pk}};
          var lookedUpPatientId = $("#patient_lookup").data("patient_id");

          rpc.send("load_matched_patient_data", [lookedUpPatientId, qrModelId],
                  function (response) {
                      if (response.status == "success") {
                          gui.clearPatientData();
                          gui.loadPatientData(response.result);
                          gui.showPatientPanel();
                      }
                      else {
                          gui.showError(result.errorMessage);
                      }
                      ;
                  });
      });
  });
</script>
{% endblock %}

{% block content %}
    {% if request.user.is_authenticated %}
        {{ block.super }}
        <div class="row">
        <div class="col-md-12">
            <p><h3><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> Questionnaire Response</h3></p>
        </div>
        </div>
    <br>
        <div class="row">
            <div class="col-md-10">

             <div id="patient-info" class="panel panel-info">
               <div class="panel-heading">Existing Patient Lookup <i>Type name to find a patient to match with or leave blank to create a new patient from the questionnaire response</i></div>
                    <div class="panel-body">
                        <div class="row">
			    <input  type="radio" name="handle_action" value="create" checked>Create New Patient From Questionnaire Response
			    <input  type="radio" name="handle_action" value="update">Update Existing Patient From Questionnaire Response<br>
			    <div id="load_patient">
			      Lookup Patient: <input id="patient_lookup" name="patient_lookup" value=""/>
                              <button id="load_patient_button">Load this patient</button>
			    </div>
                        </div>
                    </div>

             </div>

             <div class="panel panel-default">
               <div class="panel-heading">Patient Info</div>

                            <div id="patient-info-result" class="panel-body">
			      
                            </div>

		    </div>
	     <div class="row">
		  <div class="col-md-12">
		   <div id="questionnaire_data" class="panel panel-default">
                     <div class="panel panel-heading">Questionnaire Data</div>
                     <div class="panel panel-body">
                       <div id="patient_data">
			 <table class="table table-bordered table-striped">
                           <tbody>
                             <tr>
                               <th>Data Element</th>
			       <th>Existing Data</th>
			       <th>Questionnaire Value</th>
			       <th>Use</th>
                             </tr>
			      {% for question in questionnaire.questions %}
			     <tr>
			       <td>{{question.name}}</td>
			       <td><span class="label label-info">NO DATA</span></td>
			       <td><span class="label label-success">{{question.answer}}</span></td>
			       <td><input id="{{question.id}}" type="checkbox" checked="checked"/></td>
			     </tr>
			     {% endfor %}

                           </tbody>
                         </table>
                       </div><!-- patient data -->
                     </div><!-- panel body -->
                   </div><!-- panel -->
		  </div><!-- col -->

             </div>
	     


	    </div>  <!-- col10 -->
	      
	     
   


	      <div class="col-md-2">
              <div data-spy="affix" style="width: 150px;">
                <button id="savebutton" type="submit" class="btn btn-success btn-block" value="Save">
                  <span class="glyphicon glyphicon-floppy-save" aria-hidden="true"></span> Save
                </button>
                <a href="" class="btn btn-danger btn-block">
                  <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Cancel
                </a>
              </div>
              </div>
	      
	    </div>



    {% else %}
        <div class="alert alert-info">Please log in to access the registry.</div>
    {% endif %}
{% endblock%}

