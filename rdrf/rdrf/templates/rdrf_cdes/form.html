{% extends "admin/base_site.html" %}
{% load get_display_name %}
{% load is_formset %}
{% load get_management_form %}
{% load lookup %}
{% load get_forms %}
{% load get_form %}
{% load static %}

{% block extrastyle %}
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>

    <script type="text/javascript" src="{% static 'js/form.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/calculated_field_plugin.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/dynamic_formsets_plugin.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/toggle_disabled.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/hgvs.js' %}"></script>

    <script type="text/javascript">
        window.IMAGES_URL = "{% static 'images/' %}";
        window.HGVS_URL = "{% url 'hgvs_validator' %}";
    </script>

{% endblock %}

{% block content %}
<h2>Patient: <a href="{% url 'admin:patients_patient_change' patient_id %}">{{ patient_name }}</a></h2>

<form enctype="multipart/form-data" method="post">{% csrf_token %}
{% for s in sections %}

<table class="table table-striped table-bordered table-hover table-condensed">
        
    <thead>
        <tr>
            <th>{{display_names|get_display_name:s}}</th>
        </tr>
    </thead>

    <tbody>
        <tr>
            <th>
                {% if forms|is_formset:s %}
                <!-- start management form for {{s}}-->
                {{ forms|get_management_form:s }}
                <!-- end management form for {{s}} -->
                <a href="#" id="add_button_for_section_{{s}}" class="btn btn-success btn-small"><i class="icon-white icon-plus"></i> Add</a>
                <table id="section_table_{{s}}">
                <script>
                    $(document).ready(function() {
                        $("#section_table_{{s}}").allow_dynamic_formsets({
                            cde_codes: '{{section_field_ids_map|lookup:s}}',
                            add_button_id: "add_button_for_section_{{s}}",
                            remove_button_id: "remove_button_for_section_{{s}}",
                            table_id: "section_table_{{s}}",
                            total_forms_id: "{{total_forms_ids|lookup:s}}",
                            initial_forms_id: "{{initial_forms_ids|lookup:s}}",
                            formset_prefix: "{{formset_prefixes|lookup:s}}"
                        });
                    });
                </script>
            
                {% for f in forms|get_forms:s %}
                  {{ f.as_table }}
                  <tr id="remove_formset_{{s}}_{{forloop.counter0}}" class="actionbutton">
                    <td onclick="do_remove(this,'section_table_{{s}}',{{section_element_map|lookup:s|length}},'id_formset_{{s}}-TOTAL_FORMS','id_formset_{{s}}-INITIAL_FORMS');"><a href="#" class="btn btn-danger btn-small"><i class="icon-white icon-minus"></i> Remove</a>
                    </td>
                  </tr>
                {% endfor %}
            
                </table>
              {% else %}
                <table class="table table-condensed table-hover">
                  {{forms|get_form:s}}
                </table>
              {% endif %}
            </th>
        </tr>
    </tbody>
</table>

{% endfor %}
<input type="submit" class="btn btn-primary pull-right" value="Save"/>
</form>

{% endblock %}

{% if form.errors %}
  {% for field in form %}
    {% for error in field.errors %}
      <div class="alert alert-error">
        <strong>{{ error|escape }}</strong>
      </div>
    {% endfor %}
  {% endfor %}
  {% for error in form.non_field_errors %}
    <div class="alert alert-error">
      <strong>{{ error|escape }}</strong>
    </div>
  {% endfor %}
{% endif %}

<script>
  $(document).ready(function () {
    $("label:not(li label)").addClass("col-sm-2 control-label");
    $(":input").addClass("form-control");
    $("label[for*='-clear']").removeClass();
  })
</script>