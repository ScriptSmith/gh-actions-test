{% load staticfiles %}
{% load get_form %}
{% load get_forms %}
{% load is_formset %}
{% load get_elements %}
{% load get_management_form %}
{% load get_display_name %}
{% load lookup %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>{{registry|upper}} Registry</title>
<link rel="stylesheet" type="text/css" href="{% static 'css/registry.css' %}"/>
<link rel="stylesheet" type="text/css" href="/static/admin/css/forms.css">
<link rel="stylesheet" type="text/css" href="/static/admin/css/base.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
<script type="text/javascript" src="{% static 'js/calculated_field_plugin.js' %}"></script>
<script type="text/javascript" src="{% static 'js/dynamic_formsets_plugin.js' %}"></script>
<!--[if IE 6]>
<link rel="stylesheet" type="text/css" href="{% static 'css/ie6.css' %}"/>
<![endif]-->
<!--[if IE 7]>
<link rel="stylesheet" type="text/css" href="{% static 'css/ie7.css' %}"/>
<![endif]-->

</head>
<body>
<script>
        function do_remove(id, total_forms_id) {
            var sel = "#" + id;
            $(sel).remove();
            var old_value = parseInt($('#' + total_forms_id).val());
            var new_value = old_value - 1;
            $('#' + total_forms_id).val(new_value.toString());
        }
    </script>
  <!-- Header -->
    <div id="header">
        <div id="branding">
            <h1 id="site-name">{{registry|upper}} Registry</h1>
            <h2>{{form_display_name|upper}}</h2>
        </div>

        <div id="user-tools">
            Welcome,
            <strong>admin</strong>.
                <a href="/admin/password_change/">Change password</a> /
                <a href="/admin/logout/">Log out</a>
        </div>
    </div>
    <!-- END Header -->

    <div id="content" class="colM">
    {% if messages %}
    <ul class="messagelist">
        {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
        <h2>Patient: <a href="{% url 'admin:patients_patient_change' patient_id %}">{{ patient_name }}</a></h2>
            
            <div id="content-main">
                <form action="/{{registry}}/forms/{{form_name}}/{{patient_id}}" method="post">{% csrf_token %}
                    {% for s in sections %}
                        <div class="inline-group">
                            <h2>{{display_names|get_display_name:s}} </h2>
                            {% if forms|is_formset:s %}
                                <!-- start management form for {{s}}-->
                                {{ forms|get_management_form:s }}
                                <!-- end management form for {{s}} -->
                                <div id="add_button_for_section_{{s}}" class="actionbutton">Add</div>
                                <table id="section_table_{{s}}">
                                <script>
                                    $(document).ready(function() {
                                        $("#section_table_{{s}}").allow_dynamic_formsets({
                                            cde_codes: '{{section_element_map|get_elements:s}}',
                                            add_button_id: "add_button_for_section_{{s}}",
                                            remove_button_id: "remove_button_for_section_{{s}}",
                                            table_id: "section_table_{{s}}",
                                            total_forms_id: "{{total_forms_ids|lookup:s}}",
                                            formset_prefix: "{{formset_prefixes|lookup:s}}"
                                        });
                                    });

                                </script>

                                {% for f in forms|get_forms:s %}
                                    <div id="formset_{{s}}_{{forloop.counter0}}">
                                    {{ f.as_table }}

                                    <div id="remove_formset_{{s}}_{{forloop.counter0}}" onclick="do_remove('formset_{{s}}_{{forloop.counter0}}','id_formset_{{s}}-TOTAL_FORMS');" class="actionbutton">Remove</div>
                                    </div>

                                {% endfor %}


                                </table>
                            {% else %}
                                <table>
                                {{forms|get_form:s}}
                                </table>
                            {% endif %}
                        </div>
                        <!--<fieldset><legend>{{s}}</legend>
                        </fieldset>-->
                    {% endfor %}
                    <input type="submit" value="Submit" />
                </form>
            </div>
    </div>


    {% if form.errors %}
    {% for field in form %}
        {% for error in field.errors %}
            <div class="alert alert-error">
                <strong>{{ error|escape }}</strong>
            </div>
        {% endfor %}
    {% endfor %}
    {% for error in form.non_field_errors %}
        <div class="alert alert-error">
            <strong>{{ error|escape }}</strong>
        </div>
    {% endfor %}
{% endif %}
</body>
</html>