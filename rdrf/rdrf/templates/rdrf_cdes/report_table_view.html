{% extends "rdrf_cdes/base.html" %}
{% load static from staticfiles %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>

{% endblock %}

{% block extrahead %}
    <script>

    var COLUMNS = {{columns|safe }};
    var TABLE_ID = "report_table";
    var TABLE_LENGTH_SELECT = "report_table_length";

    var Report = function(registryCode, columns, length) {
        this.registryCode = registryCode;
        this.baseApiUrl = "{{ api_url  }}";
        this.length = length;
        this.table = $("#" + TABLE_ID).DataTable({"processing": true,
                                                   "serverSide": true,
                                                    ajax: {
                                                        url: this.getUrl(),
                                                        dataSrc: "rows",
                                                        type: "POST"
                                                    },
                                                    columns: columns});
    };

    Report.prototype.getApiUrl = function(registryCode) {
        return  this.baseApiUrl + "?registry_code=" + registryCode + "&length=" + this.length;
    };

    Report.prototype.getUrl = function () {
        return this.getApiUrl(this.registryCode);
    };


    Report.prototype.load = function() {
        var url = this.getUrl();
        alert(url);
        this.table.ajax.url(url).load();
    }

    function setUpCSRFToken() {
         $.ajaxSetup({beforeSend: function (xhr) {
                    var csrfToken = '{{ csrf_token }}';
                    xhr.setRequestHeader('X-CSRFToken', csrfToken);
                }});
    }

    function hookupLengthSelect(report) {
        $("#" + TABLE_LENGTH_SELECT).change(function () {
            report.length = $("#" + TABLE_LENGTH_SELECT).find("option:selected").val();
            //report.load();
        })
    }

    $(document).ready(
            function () {
                setUpCSRFToken();
                var registryCode = "{{ registry_code }}";
                var initial_length = 10;
                var report = new Report(registryCode, COLUMNS, initial_length);
                hookupLengthSelect(report);

            });
    </script>

{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-md-12">
            <p><h3><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> RDRF Report Table</h3></p>
            <i class="text-muted"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> {{user.first_name}} {{user.last_name}} ({{user.title}})</i>
        </div>
    </div>

    <br>

    <div class="well">
        SQL QUERY
        <br>
        <table id="report_table" class="table table-striped table-hover">
        <thead>
            <tr>
                {% for column in columns %}
                    <th>{{ column.label|safe }}</th>
                {% endfor %}
            </tr>
        </thead>
    </table>
        <br>
        COMMMAND MENU
    </div>

{% endblock %}
